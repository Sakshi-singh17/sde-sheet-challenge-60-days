name: Daily LeetCode Auto Push

on:
  schedule:
    - cron: '0 18 * * *'  # 18:00 UTC = 23:30 IST daily
  workflow_dispatch:      # allow manual trigger

permissions:
    contents: write


jobs:
  daily_upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0         # full history (safe)
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install requests
        run: |
          pip install requests

      - name: Fetch latest LeetCode solutions
        env:
          LEETCODE_SESSION: ${{ secrets.LEETCODE_SESSION }}
        run: |
          python - <<'PY'
          import os, requests, json
          from pathlib import Path

          # CONFIG
          USERNAME = "Sakshi_Singh17"
          CODE_DIR = Path("src")
          LIMIT = 10    # how many recent submissions to check

          cookie = os.getenv("LEETCODE_SESSION")
          if not cookie:
              raise SystemExit("LEETCODE_SESSION secret is missing")

          headers = {
              "cookie": f"LEETCODE_SESSION={cookie}",
              "referer": "https://leetcode.com",
              "User-Agent": "Mozilla/5.0"
          }

          # call LeetCode submissions API
          url = f"https://leetcode.com/api/submissions/?offset=0&limit={LIMIT}"
          r = requests.get(url, headers=headers)
          r.raise_for_status()
          data = r.json()

          CODE_DIR.mkdir(parents=True, exist_ok=True)
          existing_days = sorted([d.name for d in CODE_DIR.iterdir() if d.is_dir() and d.name.startswith("day")],
                                 key=lambda x: int(x[3:]) if x[3:].isdigit() else 0)
          if existing_days:
              last_num = int(existing_days[-1][3:]) if existing_days[-1][3:].isdigit() else 0
              next_day = f"day{last_num+1}"
          else:
              next_day = "day1"

          day_path = CODE_DIR / next_day
          day_path.mkdir(parents=True, exist_ok=True)

          saved = 0
          for sub in data.get("submissions_dump", []):
              # fields observed: status_display, lang, title_slug, code
              if sub.get("status_display") == "Accepted" and sub.get("lang", "").lower() == "java":
                  title = sub.get("title_slug") or sub.get("title", "problem")
                  filename = title.replace("-", "_") + ".java"
                  code_text = sub.get("code") or ""
                  if code_text:
                      filepath = day_path / filename
                      # avoid overwriting existing file with same name
                      if not filepath.exists():
                          filepath.write_text(code_text, encoding="utf-8")
                          saved += 1

          print(f"Saved {saved} files to {day_path}")
          PY

      - name: Commit and Push
        run: |
          git config user.name "Sakshi Singh"
          git config user.email "sakshi@example.com"    # change if you want your real email
          git add src || true
          git commit -m "Auto upload LeetCode solutions â€“ $(date -u +'%Y-%m-%d %H:%M:%S UTC')" || echo "No changes to commit"
          git push
