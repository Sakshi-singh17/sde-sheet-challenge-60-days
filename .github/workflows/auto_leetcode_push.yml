name: Daily LeetCode Auto Push

permissions:
  contents: write

on:
  schedule:
    - cron: "00 18 * * *"   # Runs daily at 11:30 PM IST
  workflow_dispatch:

jobs:
  auto-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install requests

      - name: Fetch latest LeetCode solutions
        env:
          LEETCODE_SESSION: ${{ secrets.LEETCODE_SESSION }}
        run: |
          python <<'EOF'
          import os
          import requests

          username = "Sakshi_Singh17"
          cookie = os.getenv("LEETCODE_SESSION")
          headers = {
              "cookie": f"LEETCODE_SESSION={cookie}",
              "referer": "https://leetcode.com",
              "User-Agent": "Mozilla/5.0"
          }

          # Fetch latest 10 submissions
          url = "https://leetcode.com/api/submissions/?offset=0&limit=10"
          response = requests.get(url, headers=headers)
          data = response.json()

          base_dir = "src"
          os.makedirs(base_dir, exist_ok=True)

          # Find next day folder
          existing_days = [d for d in os.listdir(base_dir) if d.startswith("day")]
          if existing_days:
              nums = [int(d[3:]) for d in existing_days if d[3:].isdigit()]
              next_day = f"day{max(nums) + 1}"
          else:
              next_day = "day1"

          day_path = os.path.join(base_dir, next_day)
          os.makedirs(day_path, exist_ok=True)

          # Collect existing problem filenames
          existing_files = []
          for d in existing_days:
              folder = os.path.join(base_dir, d)
              for f in os.listdir(folder):
                  if f.endswith(".java"):
                      existing_files.append(f)

          added = 0
          for sub in data.get("submissions_dump", []):
              if sub["status_display"] == "Accepted" and sub["lang"] == "java":
                  filename = sub["title_slug"].replace("-", "_") + ".java"
                  if filename in existing_files:
                      continue  # Skip duplicates
                  code = sub["code"]
                  with open(os.path.join(day_path, filename), "w", encoding="utf-8") as f:
                      f.write(code)
                  added += 1

          if added == 0:
              print("✅ No new problems found today. Skipping commit.")
              with open("skip_commit.txt", "w") as f:
                  f.write("skip")
          else:
              print(f"✅ Added {added} new problems to {day_path}")
          EOF

      - name: Commit & push changes
        run: |
          if [ -f "skip_commit.txt" ]; then
            echo "No new problems. Skipping push."
            exit 0
          fi

          git config --global user.email "sakshisingh@example.com"
          git config --global user.name "Sakshi Singh"
          git add .
          git commit -m "Auto upload LeetCode solutions – $(date -u)"
          git push
