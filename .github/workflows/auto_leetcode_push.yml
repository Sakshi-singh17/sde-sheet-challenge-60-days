name: Daily LeetCode Auto Push

permissions:
  contents: write

on:
  schedule:
    - cron: "00 18 * * *"   # Runs daily at 11:30 PM IST
  workflow_dispatch:

jobs:
  auto-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install requests

      - name: Fetch latest LeetCode solutions
        env:
          LEETCODE_SESSION: ${{ secrets.LEETCODE_SESSION }}
        run: |
          python <<'EOF'
          import os
          import requests
          from datetime import datetime

          username = "Sakshi_Singh17"
          cookie = os.getenv("LEETCODE_SESSION")
          headers = {
              "cookie": f"LEETCODE_SESSION={cookie}",
              "referer": "https://leetcode.com",
              "User-Agent": "Mozilla/5.0"
          }

          url = "https://leetcode.com/api/submissions/?offset=0&limit=20"
          response = requests.get(url, headers=headers)
          data = response.json()

          base_dir = "src"
          os.makedirs(base_dir, exist_ok=True)

          # --- Determine current day folder based on date ---
          today = datetime.now().strftime("%Y-%m-%d")

          # Find latest existing folder (like day1, day2...) or create day1 if none exist
          existing_days = [d for d in os.listdir(base_dir) if d.startswith("day")]
          if existing_days:
              nums = [int(d[3:]) for d in existing_days if d[3:].isdigit()]
              latest_day = max(nums)
              latest_folder = f"day{latest_day}"

              # Check if latest folder corresponds to today's date
              date_file = os.path.join(base_dir, latest_folder, "date.txt")
              if os.path.exists(date_file):
                  with open(date_file, "r") as f:
                      folder_date = f.read().strip()
              else:
                  folder_date = None

              if folder_date == today:
                  day_folder = latest_folder
              else:
                  day_folder = f"day{latest_day + 1}"
          else:
              day_folder = "day1"

          day_path = os.path.join(base_dir, day_folder)
          os.makedirs(day_path, exist_ok=True)

          # Save today's date for reference
          with open(os.path.join(day_path, "date.txt"), "w") as f:
              f.write(today)

          # --- Collect existing problem filenames ---
          existing_files = {}
          for f in os.listdir(day_path):
              if f.endswith(".java"):
                  base = f[:-5]  # remove .java
                  existing_files.setdefault(base.split("_v")[0], []).append(f)

          added = 0
          for sub in data.get("submissions_dump", []):
              if sub["status_display"] == "Accepted" and sub["lang"] == "java":
                  base_name = sub["title_slug"].replace("-", "_")
          
                  # Handle multiple versions for same problem
                  if base_name in existing_files:
                      version = len(existing_files[base_name]) + 1
                      filename = f"{base_name}_v{version}.java"
                  else:
                      filename = f"{base_name}_v1.java"

                  code = sub["code"]
                  with open(os.path.join(day_path, filename), "w", encoding="utf-8") as f:
                      f.write(code)

                  existing_files.setdefault(base_name, []).append(filename)
                  added += 1

          if added == 0:
              print("✅ No new problems found today. Skipping commit.")
              with open("skip_commit.txt", "w") as f:
                  f.write("skip")
          else:
              print(f"✅ Added {added} new solutions to {day_path}")
          EOF

      - name: Commit & push changes
        run: |
          if [ -f "skip_commit.txt" ]; then
            echo "No new problems. Skipping push."
            exit 0
          fi

          git config --global user.email "sakshisingh@example.com"
          git config --global user.name "Sakshi Singh"
          git add .
          git commit -m "Auto upload LeetCode solutions – $(date -u)"
          git push
